<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dante Screen - Viewer</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <main>
    <h1>Dante Screen (Viewer)</h1>
    <p id="info"></p>
    <div id="overlay" style="display:none; margin: 12px 0;">
      <button id="play">Tap to start</button>
    </div>
    <video id="remote" autoplay playsinline controls></video>
  </main>

  <script>
    const info = document.getElementById('info');
    const video = document.getElementById('remote');
    const overlay = document.getElementById('overlay');
    const playBtn = document.getElementById('play');
    const params = new URLSearchParams(location.search);
    const DEFAULT_ROOM = 'live';
    const room = params.get('room') || DEFAULT_ROOM;
    // Allow autoplay; unmute after user gesture
    video.muted = true;

    let pc, ws;
    const paramsAll = new URLSearchParams(location.search);
    const forceRelay = paramsAll.get('relay') === '1';

    function update(t){ info.textContent = t; }

    function connectWS() {
      return new Promise((resolve, reject) => {
        ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host);
        ws.onopen = () => { ws.send(JSON.stringify({ type: 'join', role: 'viewer', room })); resolve(); };
        ws.onerror = reject;
        ws.onmessage = async (ev) => {
          const msg = JSON.parse(ev.data);
          if (msg.type === 'offer') {
            let iceServers = [{ urls: 'stun:stun.l.google.com:19302' }];
            try {
              const r = await fetch('/config');
              const cfg = await r.json();
              if (Array.isArray(cfg.iceServers)) iceServers = cfg.iceServers;
            } catch {}
            pc = new RTCPeerConnection({ iceServers, iceTransportPolicy: forceRelay ? 'relay' : 'all' });
            const tryPlay = async () => {
              try { await video.play(); overlay.style.display = 'none'; }
              catch { overlay.style.display = 'block'; }
            };
            // Ensure video transceiver exists (helps some browsers)
            try { pc.addTransceiver('video'); } catch {}
            pc.ontrack = (e) => {
              video.srcObject = e.streams[0];
              tryPlay();
            };
            pc.onicecandidate = (e) => {
              if (e.candidate) ws.send(JSON.stringify({ type: 'ice-candidate', candidate: e.candidate }));
            };
            await pc.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp: msg.sdp }));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            ws.send(JSON.stringify({ type: 'answer', sdp: answer.sdp }));
            update('Connected to sender');
          } else if (msg.type === 'ice-candidate' && msg.candidate) {
            try { await pc.addIceCandidate(msg.candidate); } catch {}
          } else if (msg.type === 'sender-disconnected') {
            update('Sender disconnected');
            try { pc?.close(); } catch {}
          } else if (msg.type === 'sender-ready') {
            update('Waiting for offer...');
          } else if (msg.type === 'error') {
            update('Error: ' + (msg.reason || 'unknown'));
          }
        };
      });
    }

    playBtn?.addEventListener('click', async () => {
      try { video.muted = false; await video.play(); overlay.style.display = 'none'; } catch {}
    });
    video.addEventListener('click', async () => { try { video.muted = false; await video.play(); } catch {} });

    (async () => {
      if (!room) return;
      try { await connectWS(); update('Waiting for sender...'); } catch { update('Failed to connect'); }
    })();
  </script>
</body>
</html>
